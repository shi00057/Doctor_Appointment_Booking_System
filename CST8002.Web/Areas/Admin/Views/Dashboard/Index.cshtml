@model CST8002.Web.Areas.Admin.ViewModels.Reports.AdminReportsIndexVm
@{
    ViewData["Title"] = "Reports";
    var hasRows = (Model?.Rows?.Count ?? 0) > 0;
    var columns = hasRows ? Model.Rows[0].GetType().GetProperties() : Array.Empty<System.Reflection.PropertyInfo>();
    var totalsProps = Model.Totals?.GetType().GetProperties() ?? Array.Empty<System.Reflection.PropertyInfo>();
}

<form asp-area="Admin" asp-controller="Reports" asp-action="Index" method="get" class="mb-3">
    <div class="row g-2">
        <div class="col-auto">
            <label class="form-label">DoctorId</label>
            <input name="doctorId" class="form-control" value="@(Model.DoctorId == 0 ? "" : Model.DoctorId.ToString())" />
        </div>
        <div class="col-auto">
            <label class="form-label">From</label>
            <input name="from" type="date" class="form-control" value="@Model.From.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-auto">
            <label class="form-label">To</label>
            <input name="to" type="date" class="form-control" value="@Model.To.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-auto align-self-end">
            <button type="submit" class="btn btn-primary">Run</button>
            @if (Model.DoctorId > 0)
            {
                <a class="btn btn-secondary"
                   asp-area="Admin"
                   asp-controller="Reports"
                   asp-action="ExportCsv"
                   asp-route-doctorId="@Model.DoctorId"
                   asp-route-from="@Model.From.ToString("O")"
                   asp-route-to="@Model.To.ToString("O")">
                    Export CSV
                </a>
            }
        </div>
    </div>
</form>

@if (Model.DoctorId == 0)
{
    <div class="alert alert-info">Enter DoctorId and date range to view report.</div>
}
else
{
    <div class="card mb-3">
        <div class="card-header">Totals</div>
        <div class="card-body">
            @if (Model.Totals is null || totalsProps.Length == 0)
            {
                <div class="text-muted">No totals.</div>
            }
            else
            {
                <div class="row">
                    @foreach (var p in totalsProps)
                    {
                        var v = p.GetValue(Model.Totals);
                        <div class="col-md-3 mb-2">
                            <div class="fw-bold">@p.Name</div>
                            <div>@(v is DateTime dt ? dt.ToString("yyyy-MM-dd HH:mm") : v)</div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <div class="card">
        <div class="card-header">Details</div>
        <div class="card-body">
            @if (!hasRows)
            {
                <div class="text-muted">No rows.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle">
                        <thead>
                            <tr>
                                @foreach (var c in columns)
                                {
                                    <th>@c.Name</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in Model.Rows)
                            {
                                <tr>
                                    @foreach (var c in columns)
                                    {
                                        var val = c.GetValue(row);
                                        <td>@(val is DateTime dt ? dt.ToString("yyyy-MM-dd HH:mm") : val)</td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}
